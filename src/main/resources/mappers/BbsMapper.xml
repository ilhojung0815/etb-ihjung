<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.emptybeer.etb.mappers.IBbsMapper">
    <select id="selectBoardById" resultType="com.emptybeer.etb.entities.bbs.BoardEntity">
        SELECT `id`   AS `id`,
               `text` AS `text`
        FROM `etb_bbs`.`boards`
        WHERE BINARY `id` = #{id}
        LIMIT 1
    </select>
    <select id="selectBeerByIndex" resultType="com.emptybeer.etb.vos.BeerVo">
        SELECT `beer`.`index`          AS `index`,
               `beer`.`name`           AS `name`,
               `beer`.image            AS `image`,
               `beer`.image_type       AS `imageType`,
               `beer`.mfr              AS `mfr`,
               `beer`.calorie          AS `calorie`,
               `beer`.volume           AS `volume`,
               `beer`.degree           AS `degree`,
               `beer`.`description`    AS `description`,
               LEFT(`description`, 68) AS `descriptionShort`,
               `beer`.`category_index` AS `categoryIndex`,
               `beerCategory`.`text`   AS `categoryText`,
               `beer`.created_on       AS `createdOn`,
               `beer`.modified_on      AS `modifiedOn`
        FROM etb_data.beers AS `beer`
                 LEFT JOIN `etb_data`.`beer_categories` AS `beerCategory`
                           ON `beer`.`category_index` = `beerCategory`.`index`
        WHERE `beer`.`index` = #{beerIndex}
    </select>
    <select id="selectBeerLikeByIndex" resultType="com.emptybeer.etb.vos.BeerVo">
        SELECT `beer`.`index`                      AS `index`,
               `beer`.`name`                       AS `name`,
               `beer`.image                        AS `image`,
               `beer`.image_type                   AS `imageType`,
               `beer`.mfr                          AS `mfr`,
               `beer`.calorie                      AS `calorie`,
               `beer`.volume                       AS `volume`,
               `beer`.degree                       AS `degree`,
               `beer`.`description`                AS `description`,
               LEFT(`description`, 68)             AS `descriptionShort`,
               `beer`.`category_index`             AS `categoryIndex`,
               `beerCategory`.`text`               AS `categoryText`,
               `beer`.created_on                   AS `createdOn`,
               `beer`.modified_on                  AS `modifiedOn`,
               (#{userEmail} IS NOT NULL)          AS `isSigned`,
               COUNT(`beerLike`.`beer_index`) > 0  AS `isLiked`,
               COUNT(`beerLikeCount`.`beer_index`) AS `likeCount`
        FROM etb_data.beers AS `beer`
                 LEFT JOIN `etb_data`.`beer_categories` AS `beerCategory`
                           ON `beer`.`category_index` = `beerCategory`.`index`
                 LEFT JOIN `etb_data`.`beer_likes` AS `beerLike`
                           ON `beer`.`index` = `beerLike`.`beer_index`
                               AND `beerLike`.user_email = IFNULL(#{userEmail}, '')
                 LEFT JOIN `etb_data`.`beer_likes` AS `beerLikeCount`
                           ON `beer`.`index` = `beerLikeCount`.`beer_index`
        WHERE `beer`.`index` = #{beerIndex}
    </select>
    <insert id="insertReviewArticle"
            useGeneratedKeys="true"
            keyColumn="index"
            keyProperty="index"
            parameterType="com.emptybeer.etb.entities.bbs.ReviewArticleEntity">
        INSERT INTO `etb_bbs`.`review_articles` (user_email, beer_index, score, content_good, content_bad, declaration,
                                                 written_on, modified_on)
        VALUES (#{userEmail}, #{beerIndex}, #{score}, #{contentGood}, #{contentBad}, #{declaration},
                IFNULL(#{writtenOn}, DEFAULT(`written_on`)),
                IFNULL(#{modifiedOn}, DEFAULT(`modified_on`)))
    </insert>
    <select id="selectReviewByBeerIndex" resultType="int">
        SELECT COUNT(*)
        FROM etb_bbs.review_articles
        WHERE user_email = #{userEmail}
          AND beer_index = #{beerIndex}
    </select>
    <select id="selectReviewArticleCountByBeerIndex"
            resultType="int">
        SELECT COUNT(0)
        FROM etb_bbs.review_articles AS `reviewArticle`
        <if test="criterion != null and criterion.equals('nickname')">
            LEFT JOIN `etb_member`.`users` AS `user` ON `reviewArticle`.`user_email` = `user`.`email`
        </if>
        WHERE beer_index = #{beerIndex}
        <if test="criterion != null and criterion.equals('content')">
            AND (REPLACE(reviewArticle.`content_good`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%')
            OR REPLACE(reviewArticle.`content_bad`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%'))
        </if>
        <if test="criterion != null and criterion.equals('nickname')">
            AND BINARY `user`.nickname = #{keyword}
        </if>
    </select>
    <select id="selectReviewAvgByBeerIndex"
            resultType="double">
        SELECT ROUND(AVG(score), 1)
        FROM etb_bbs.review_articles AS `reviewArticle`
        WHERE beer_index = #{beerIndex}
        GROUP BY beer_index
    </select>
    <select id="selectReviewArticleByBeerIndex"
            resultType="com.emptybeer.etb.vos.ReviewArticleVo">
        SELECT `reviewArticle`.`index` AS `index`,
        `reviewArticle`.user_email AS `userEmail`,
        `reviewArticle`.board_id AS `boardId`,
        `reviewArticle`.beer_index AS `beerIndex`,
        `beer`.`name` AS `beerName`,
        `reviewArticle`.`score` AS `score`,
        `reviewArticle`.`content_good` AS `contentGood`,
        `reviewArticle`.`content_bad` AS `contentBad`,
        `reviewArticle`.`declaration` AS `declaration`,
        `reviewArticle`.`written_on` AS `writtenOn`,
        `reviewArticle`.`modified_on` AS `modifiedOn`,
        `user`.`nickname` AS `usernickname`
        FROM etb_bbs.review_articles AS `reviewArticle`
        LEFT JOIN `etb_member`.`users` AS `user` ON `user`.`email` = `reviewArticle`.`user_email`
        LEFT JOIN `etb_data`.`beers` AS `beer` ON `beer`.`index` = `reviewArticle`.beer_index
        WHERE `reviewArticle`.`beer_index` = #{beerIndex}
        <if test="criterion != null and criterion.equals('content')">
            AND (REPLACE(reviewArticle.`content_good`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%')
            OR REPLACE(reviewArticle.`content_bad`, ' ', '') LIKE CONCAT('%', REPLACE(#{keyword}, ' ', ''), '%'))
        </if>
        <if test="criterion != null and criterion.equals('nickname')">
            AND BINARY `user`.`nickname` = #{keyword}
        </if>
        GROUP BY `reviewArticle`.`index`
        ORDER BY `reviewArticle`.`index` DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <insert id="insertBeerLike"
            parameterType="com.emptybeer.etb.entities.data.BeerLikeEntity">
        INSERT INTO etb_data.beer_likes (`user_email`, `beer_index`, `created_on`)
        VALUES (#{userEmail}, #{beerIndex}, IFNULL(#{createdOn}, DEFAULT(`created_on`)))
    </insert>
    <delete id="deleteBeerLike"
            parameterType="com.emptybeer.etb.entities.data.BeerLikeEntity">
        DELETE
        FROM etb_data.beer_likes
        WHERE user_email = #{userEmail}
          AND `beer_index` = #{beerIndex}
        LIMIT 1
    </delete>
    <select id="selectLikeIndex" resultType="com.emptybeer.etb.vos.ReviewArticleVo">
        SELECT `reviewArticle`.`index`                      AS `index`,
               `reviewArticle`.`user_email`                 AS `userEmail`,
               `reviewArticle`.`board_id`                   AS `boardId`,
               `reviewArticle`.beer_index                   AS `beerIndex`,
               `beer`.`name`                                AS `beerName`,
               `reviewArticle`.`score`                      AS `score`,
               `reviewArticle`.`content_good`               AS `contentGood`,
               `reviewArticle`.`content_bad`                AS `contentBad`,
               `reviewArticle`.`declaration`                AS `declaration`,
               `reviewArticle`.`written_on`                 AS `writtenOn`,
               `reviewArticle`.`modified_on`                AS `modifiedOn`,
               `user`.`nickname`                            AS `userNickname`,
               (#{userEmail} IS NOT NULL)                   AS `isSigned`,
               COUNT(`reviewArticleLike`.article_index) > 0 AS `isLiked`,
               COUNT(`reviewLikeCount`.`article_index`)     AS `likeCount`
        FROM `etb_bbs`.`review_articles` AS `reviewArticle`
                 LEFT JOIN `etb_member`.`users` AS `user` ON `reviewArticle`.`user_email` = `user`.`email`
                 LEFT JOIN `etb_data`.`beers` AS `beer` ON `reviewArticle`.`beer_index` = `beer`.`index`
                 LEFT JOIN `etb_bbs`.review_article_likes AS `reviewArticleLike`
                           ON `reviewArticle`.`index` = reviewArticleLike.article_index
                               AND `reviewArticleLike`.user_email = IFNULL(#{userEmail}, '')
                 LEFT JOIN `etb_bbs`.review_article_likes AS `reviewLikeCount`
                           ON reviewArticleLike.`article_index` = `reviewLikeCount`.article_index
        WHERE BINARY `reviewArticle`.`index` = #{index}

        LIMIT 1
    </select>
    <update id="updateReview" parameterType="com.emptybeer.etb.vos.ReviewArticleVo">
        update `etb_bbs`.`review_articles`
        SET `user_email`   = #{userEmail},
            `board_id`     = #{boardId},
            `beer_index`   = #{beerIndex},
            `score`        = #{score},
            `content_good` = #{contentGood},
            `content_bad`  = #{contentBad},
            `declaration`  = #{declaration},
            `written_on`   = #{writtenOn},
            `modified_on`  = #{modifiedOn}
        WHERE `index` = #{index}
        LIMIT 1
    </update>
    <select id="selectIndex" resultType="com.emptybeer.etb.vos.ReviewArticleVo">
        SELECT `reviewArticle`.`index`        AS `index`,
               `reviewArticle`.`user_email`   AS `userEmail`,
               `reviewArticle`.`board_id`     AS `boardId`,
               `reviewArticle`.`beer_index`   AS `beerIndex`,
               `beer`.`name`                  AS `beerName`,
               `reviewArticle`.`score`        AS `score`,
               `reviewArticle`.`content_good` AS `contentGood`,
               `reviewArticle`.`content_bad`  AS `contentBad`,
               `reviewArticle`.`declaration`  AS `declaration`,
               `reviewArticle`.`written_on`   AS `writtenOn`,
               `reviewArticle`.`modified_on`  AS `modifiedOn`,
               `user`.`nickname`              AS `userNickname`
        FROM `etb_bbs`.`review_articles` AS `reviewArticle`
                 LEFT JOIN `etb_member`.`users` AS `user` ON `reviewArticle`.`user_email` = `user`.`email`
                 LEFT JOIN `etb_data`.beers AS `beer` ON `reviewArticle`.`beer_index` = `beer`.`index`
        WHERE BINARY `reviewArticle`.`index` = #{index}
        LIMIT 1
    </select>
    <delete id="deleteReviewByIndex"
            parameterType="com.emptybeer.etb.vos.ReviewArticleVo">
        DELETE
        FROM `etb_bbs`.review_articles
        WHERE `index` = #{index}
    </delete>



    <!--  festival관련 DAO  -->

    <select id="select">

    </select>


    <select id="selectFestivalArticle"
    resultType="com.emptybeer.etb.entities.bbs.FestivalArticleEntity">
        SELECT `festivalArticle`.`index`            AS `index`,
               `festivalArticle`.`board_id`         AS `boardId`,
               `festivalArticle`.`user_email`       AS `userEmail`,
               `festivalArticle`.`title`            AS `title`,
               `festivalArticle`.`description`      AS `description`,
               `festivalArticle`.`date_from`        AS `dateFrom`,
               `festivalArticle`.`date_to`          AS `dateTo`,
               `festivalArticle`.`time_from`        AS `timeFrom`,
               `festivalArticle`.`time_to`          AS `timeTo`,
               `festivalArticle`.`latitude`         AS `latitude`,
               `festivalArticle`.`longitude`        AS `longitude`,
               `festivalArticle`.`created_on`       AS `createdOn`,
               `festivalArticle`.`modified_on`      AS `modifiedOn`
        FROM `etb_bbs`.`festival_articles` AS `festivalArticle`
    </select>

    <select id="selectFestivalArticleImage"
    resultType="com.emptybeer.etb.entities.bbs.FestivalArticleEntity">
        SELECT `festivalArticle`.`title_image`      AS `titleImage`,
               `festivalArticle`.`title_image_type` AS `titleImageType`
        FROM `etb_bbs`.`festival_articles` AS `festivalArticle`
    </select>

    <select id="selectImageByIndex"
    resultType="com.emptybeer.etb.entities.bbs.ImageEntity">
        SELECT `image`.`index`     AS `index`,
               `image`.`file_name` AS `fileName`,
               `image`.`file_mime` AS `fileMime`,
               `image`.`data`      AS `data`
        FROM `etb_bbs`.`images` AS `image`
        WHERE `image`.`index` = #{index}
        LIMIT 1

    </select>



</mapper>